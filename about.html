<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>About the matchmaps algorithm &mdash; matchmaps</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=e9b4edf4" />

  
    <link rel="shortcut icon" href="_static/rs-favicon_32x32.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=11c6d23d"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="#" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="matchmaps command-line interface" href="cli.html" />
    <link rel="prev" title="Visualizing matchmaps results" href="visualization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            matchmaps
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting and advanced usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing results</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">About the algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-overview">Algorithm overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithmic-details">Algorithmic details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scaling">Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#refinement">Refinement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-fourier-transform">The Fourier transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#real-space-alignment">Real-space alignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solvent-masking">Solvent masking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variants-of-matchmaps">Variants of <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#matchmaps-mr"><code class="docutils literal notranslate"><span class="pre">matchmaps.mr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#matchmaps-ncs"><code class="docutils literal notranslate"><span class="pre">matchmaps.ncs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#questions-or-thoughts">Questions or thoughts?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Full command-line API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">matchmaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">About the <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> algorithm</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/about.md" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="about-the-matchmaps-algorithm">
<h1>About the <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> algorithm<a class="headerlink" href="#about-the-matchmaps-algorithm" title="Link to this heading"></a></h1>
<p>If you want to learn more about the idea behind <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code>, along with some examples, please check out paper in the Journal of Applied Crystallography!</p>
<blockquote>
<div><p><a class="reference external" href="https://journals.iucr.org/j/issues/2024/03/00/ei5112/index.html">MatchMaps: non-isomorphous difference maps for X-ray crystallography</a></p>
</div></blockquote>
<p>If you’re looking for a user guide, you can find that <a class="reference internal" href="quickstart.html"><span class="std std-doc">here</span></a>. But if you’re looking for more details about how <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> works, read on!</p>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading"></a></h2>
<p>Conformational change mediates the biological functions of macromolecules. Crystallographic measurements can map these changes with extraordinary sensitivity as a function of mutations, ligands, and time. A popular method for detecting structural differences between crystallographic datasets is the isomorphous difference map. Isomorphous difference maps combine the phases of a chosen reference state with the observed changes in structure factor amplitudes to yield a map of changes in electron density. Such maps are much more sensitive to conformational change than structure refinement is, and are unbiased in the sense that observed differences do not depend on refinement of the perturbed state. However, even modest changes in unit cell properties can render isomorphous difference maps useless. This is unnecessary. Here we describe a generalized procedure for calculating observed difference maps that retains the high sensitivity to conformational change and avoids structure refinement of the perturbed state. We have implemented this procedure in an open-source python package, MatchMaps, that can be run in any software environment supporting PHENIX and CCP4. Through examples, we show that MatchMaps “rescues” observed difference electron density maps for poorly-isomorphous crystals, corrects artifacts in nominally isomorphous difference maps, and extends to detecting differences across copies within the asymmetric unit, or across altogether different crystal forms.</p>
</section>
<section id="algorithm-overview">
<h2>Algorithm overview<a class="headerlink" href="#algorithm-overview" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Place both sets of structure factor amplitudes on a common scale using CCP4’s <code class="docutils literal notranslate"><span class="pre">SCALEIT</span></code> utility and truncate the data to the same resolution range.</p></li>
<li><p>Generate phases for each dataset via the <code class="docutils literal notranslate"><span class="pre">phenix.refine</span></code> program. For both datasets, the OFF starting model is used, and only rigid-body refinement is permitted to prevent the introduction of model bias.</p></li>
<li><p>Fourier-transform each set of complex structure factors into a real-space electron density map using the python packages <code class="docutils literal notranslate"><span class="pre">reciprocalspaceship</span></code> and <code class="docutils literal notranslate"><span class="pre">gemmi</span></code>.</p></li>
<li><p>Compute the translation and rotation necessary to overlay the two rigid-body refined models. Apply this translation-rotation to the ON real-space map such that it overlays with the OFF map. These computations are carried out using <code class="docutils literal notranslate"><span class="pre">gemmi</span></code>.</p></li>
<li><p>Subtract real-space maps voxel-wise.</p></li>
</ol>
</section>
<section id="algorithmic-details">
<h2>Algorithmic details<a class="headerlink" href="#algorithmic-details" title="Link to this heading"></a></h2>
<section id="scaling">
<h3>Scaling<a class="headerlink" href="#scaling" title="Link to this heading"></a></h3>
<p>Scaling includes fitting both an overall scale factor and an anisotropic B-factor. <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> performs scaling via the <a class="reference external" href="https://www.ccp4.ac.uk/html/scaleit.html">CCP4 <code class="docutils literal notranslate"><span class="pre">SCALEIT</span></code> utility</a>, assisted by the <a class="reference external" href="https://rs-station.github.io/rs-booster/misc.html#rs-scaleit"><code class="docutils literal notranslate"><span class="pre">rs-booster</span></code> <code class="docutils literal notranslate"><span class="pre">rs.scaleit</span></code> utility</a>.</p>
</section>
<section id="refinement">
<h3>Refinement<a class="headerlink" href="#refinement" title="Link to this heading"></a></h3>
<p>Refinement is performed via <code class="docutils literal notranslate"><span class="pre">phenix.refine</span></code>. <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> makes use of a custom <code class="docutils literal notranslate"><span class="pre">.eff</span></code> parameter template which can be found in full in the <a class="reference external" href="https://github.com/rs-station/matchmaps/blob/d59fa78c2f549904d0042e637262ef6c5171d355/src/matchmaps/_utils.py#L216">source code</a>.</p>
<p>By default, refinement includes bulk-solvent scaling, as this produces the best refinement results. However, in some cases, you may expect your ON data to include interesting signal far away from the OFF model, in regions outside the solvent mask. A common example of this would be if your ON data includes a bound ligand. In such situations, we recommend that bulk-solvent scaling be deactivated. You can find instructions for turning off bulk-solvent scaling (and for changing the solvent mask; see <a class="reference internal" href="#solvent-masking"><span class="xref myst">below</span></a>) <a class="reference internal" href="quickstart.html#other-useful-options"><span class="std std-ref">here</span></a></p>
<p>The user also has the option to perform rigid-body refinement on multiple different selections. For example, if your protein model contains multiple chains, those chains may move slightly relative to each other; you may not be interested in visualizing this shift in your difference map. In this case, you can specify the model selections that should be refined separately. Instuctions for doing so can be found <a class="reference internal" href="quickstart.html#other-useful-options"><span class="std std-ref">here</span></a>. Note that any non-macromolecule atoms in your model will be renumbered to belong to the nearest macromolecule chain using the <code class="docutils literal notranslate"><span class="pre">phenix.sort_hetatms</span></code> utility.</p>
<p>More generally, this refinement can be fully customized by providing a <code class="docutils literal notranslate"><span class="pre">.eff</span></code> file. If you’re interested in doing this, I recommend using the <a class="reference external" href="https://github.com/rs-station/matchmaps/blob/d59fa78c2f549904d0042e637262ef6c5171d355/src/matchmaps/_utils.py#L216">template found in the source code</a> as a starting point. Don’t hesitate to <a class="reference external" href="https://github.com/dennisbrookner/matchmaps/issues">file an issue on github</a> if you have any issues.</p>
</section>
<section id="the-fourier-transform">
<h3>The Fourier transform<a class="headerlink" href="#the-fourier-transform" title="Link to this heading"></a></h3>
<p>Conversion of structure factors into a real-space electron density grid is handled by <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> in python, with the help of the <code class="docutils literal notranslate"><span class="pre">reciprocalspaceship</span></code> and <code class="docutils literal notranslate"><span class="pre">gemmi</span></code> packages. This approach allows for maximum flexibility and minimal “black-box code.”</p>
<p><code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> uses the “F-obs-filtered” column for structure factor amplitudes, and the “PH2FOFCWT” column for structure factor phases. Optionally, structure factor amplitudes can be error-weighted (using “SIGF-obs-filtered” uncertainties) via the formula described in Equation 7 here: <a class="reference external" href="https://scripts.iucr.org/cgi-bin/paper?S160057672100755X"><em>reciprocalspaceship</em>: a Python library for crystallographic data analysis</a>. If you are interested in using different MTZ columns, please let me know by <a class="reference external" href="https://github.com/dennisbrookner/matchmaps/issues">filing an issue on github</a> and this feature could be added.</p>
<p>By default, both input datasets are truncated to matching resolution. Note that this is a “refine, then truncate” approach - both refinements make use of the full resolution of the dataset, and the data is only truncated afterwards. Optionally, you may provide an explicit resolution cut to be applied to both datasets; this (or error-weighting) may be useful if you believe your high-resolution reflections are noisy.</p>
<p>By default, the real-space voxels in the output maps are approximately 0.5 Angstrom cubes. If you’re planning on visualizing your maps in Coot, I recommend keeping this default; if you’re planning on visualizing your maps in PyMOL, I recommend 0.25-Angstrom spacing. Find more details <a class="reference internal" href="quickstart.html#other-useful-options"><span class="std std-ref">here</span></a>.</p>
</section>
<section id="real-space-alignment">
<h3>Real-space alignment<a class="headerlink" href="#real-space-alignment" title="Link to this heading"></a></h3>
<p>Conveniently, real-space alignment of the two rigid-body-refined models is very easy, because they’re exactly the same! <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> use C-alphas, but any atom selection would do. Then, the transformation defining this alignment is applied to the ON real-space grid, such that it aligns with the OFF real-space grid. (You can reverse this an align the OFF grid to the ON grid if you would like, as described <a class="reference internal" href="quickstart.html#other-useful-options"><span class="std std-ref">here</span></a>). Grid alignment is handled conveniently via the <code class="docutils literal notranslate"><span class="pre">gemmi</span></code> method <code class="docutils literal notranslate"><span class="pre">interpolate_grid_of_aligned_model2</span></code>.</p>
<p>Note that if you have specified multiple rigid-body selections (as described <a class="reference internal" href="#refinement"><span class="xref myst">above</span></a>), then this real-space alignment will be performed separately for each selection.</p>
</section>
<section id="solvent-masking">
<h3>Solvent masking<a class="headerlink" href="#solvent-masking" title="Link to this heading"></a></h3>
<p>The real-space alignment performed by <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> will align the molecule chain(s) of interest, but will likely <strong>mis-align</strong> any symmetry-related molecules. For this reason, it is essential to mask the symmetry-related chains out of your final maps. The main difference map output by <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> is solvent masked with a 2 Angstrom radius - pretty tight.</p>
<p>However, as discussed <a class="reference internal" href="#refinement"><span class="xref myst">above</span></a>, you may expect your ON data to include signal far away from your OFF model. To account for this possibility, <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> produces a second difference map with a more generous solvent-masking radius. This more generous radius defaults to 5 Angstroms and <a class="reference internal" href="quickstart.html#other-useful-options"><span class="std std-ref">can be changed</span></a>. The file containing this generously-masked difference map will have <code class="docutils literal notranslate"><span class="pre">_unmasked</span></code> at the end of its name; <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> output files are described <a class="reference internal" href="quickstart.html#important-map-outputs"><span class="std std-ref">here</span></a>.</p>
<p>Note that real-space normalization of the two maps is critical for producing a “balanced” difference map. This normalization is performed not on across the unit cell or the asymmetric unit, but rather on the remaining non-zero voxels after applying the more generous solvent mask.</p>
</section>
</section>
<section id="variants-of-matchmaps">
<h2>Variants of <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code><a class="headerlink" href="#variants-of-matchmaps" title="Link to this heading"></a></h2>
<p>In addition to the core <code class="docutils literal notranslate"><span class="pre">matchmaps</span></code> utility, two additional command-line functions are available: <code class="docutils literal notranslate"><span class="pre">matchmaps.mr</span></code> and <code class="docutils literal notranslate"><span class="pre">matchmaps.ncs</span></code>. The algorithm is modified slightly for each utility.</p>
<section id="matchmaps-mr">
<h3><code class="docutils literal notranslate"><span class="pre">matchmaps.mr</span></code><a class="headerlink" href="#matchmaps-mr" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">matchmaps.mr</span></code> can support two input reflection files that are in different crystal packings or spacegroups. Accordingly, step 1 above (scaling) is replaced with a round of molecular replacement (using <code class="docutils literal notranslate"><span class="pre">phenix.phaser</span></code>) wherein the OFF starting model is used as a molecular replacement solution for the ON reflections. The algorithm proceeds essentially identically from this point.</p>
<p>One small but important change in <code class="docutils literal notranslate"><span class="pre">matchmaps.mr</span></code> is that all ordered water molecules in the OFF starting model are discarded. This is important, as the ordered water molecules in one spacegroup/crystal packing are often not appropriate in a different spacegroup/crystal packing.</p>
</section>
<section id="matchmaps-ncs">
<h3><code class="docutils literal notranslate"><span class="pre">matchmaps.ncs</span></code><a class="headerlink" href="#matchmaps-ncs" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">matchmaps.ncs</span></code> creates internal difference maps across a non-crystallographic symmetry operation. This function requires a number of modifications to the core algorithm:</p>
<ul class="simple">
<li><p>Step 1 is omitted; there is only one input reflection file, so no scaling is necessary.</p></li>
<li><p>Step 2 is optional. If phases are not included, <code class="docutils literal notranslate"><span class="pre">phenix.refine</span></code> is run to generate phases. However, if phases are provided, they are used and refinement is skipped.</p></li>
<li><p>In step 4, there is only one rigid-body refined model. Alignment is performed on the two regions of the model related by NCS (e.g., two different protein chains).</p></li>
</ul>
</section>
</section>
<section id="questions-or-thoughts">
<h2>Questions or thoughts?<a class="headerlink" href="#questions-or-thoughts" title="Link to this heading"></a></h2>
<p>If you have any questions, thoughts, or suggestions regarding this algorithm and software, we would love to hear from you! The easiest way to get in touch is by <a class="reference external" href="https://github.com/rs-station/matchmaps/issues">opening an issue on GitHub</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="visualization.html" class="btn btn-neutral float-left" title="Visualizing matchmaps results" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cli.html" class="btn btn-neutral float-right" title="matchmaps command-line interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Dennis Brookner.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>